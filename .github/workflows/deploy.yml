name: Deploy VaultBot to PiLab

on:
  push:
    branches: 
      - main
      - dev
      - 'feat/**'
  workflow_dispatch:

jobs:
  # Build notification - runs for non-main branches
  notify-build:
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    
    steps:
    - name: Notify Discord - Build Success
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_DEPLOY_WEBHOOK }}
      run: |
        COMMIT_MSG=$(cat << 'EOF'
        ${{ github.event.head_commit.message }}
        EOF
        )
        
        COMMIT_JSON=$(echo "$COMMIT_MSG" | jq -Rs .)
        
        if [ "${{ github.ref_name }}" = "dev" ]; then
          TITLE="âœ… Build Successful"
          DESC="Build passed for dev branch"
          COLOR=3447003
        else
          TITLE="âœ… Build Successful"
          DESC="Build passed for branch ${{ github.ref_name }}"
          COLOR=10181046
        fi
        
        cat > /tmp/webhook.json <<WEBHOOK_EOF
        {
          "embeds": [{
            "title": "${TITLE}",
            "description": "${DESC}",
            "color": ${COLOR},
            "fields": [
              {
                "name": "Commit",
                "value": ${COMMIT_JSON},
                "inline": false
              },
              {
                "name": "Branch",
                "value": "${{ github.ref_name }}",
                "inline": true
              },
              {
                "name": "Author",
                "value": "${{ github.actor }}",
                "inline": true
              }
            ]
          }]
        }
        WEBHOOK_EOF
        
        curl -H "Content-Type: application/json" \
             -X POST \
             -d @/tmp/webhook.json \
             "$DISCORD_WEBHOOK"

  # Deployment job - only runs for main branch
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
    
    - name: Setup SSH config for Cloudflare Tunnel
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/pi_key
        chmod 600 ~/.ssh/pi_key
        cat >> ~/.ssh/config << EOF
        Host pilab
          HostName ${{ secrets.PI_HOST }}
          User ${{ secrets.PI_USERNAME }}
          IdentityFile ~/.ssh/pi_key
          ProxyCommand cloudflared access ssh --hostname %h
        EOF
    
    - name: Deploy to Pi
      run: |
        ssh -o StrictHostKeyChecking=no pilab << 'ENDSSH'
          set -e
          
          echo "ðŸš€ Starting deployment of VaultBot..."
          
          # Stop the bot (needs sudo, run as chunk)
          echo "ðŸ›‘ Stopping bot..."
          sudo systemctl stop vaultbot.service
          
          # Run deployment as pluribus user
          sudo su - pluribus << 'PLURIBUS_EOF'
            set -e
            
            cd /home/pluribus/plures/vaultbot
            
            # Verify we're in a git repo
            if [ ! -d ".git" ]; then
              echo "âŒ Not a git repository! Aborting."
              exit 1
            fi
            
            echo "ðŸ’¾ Creating safety backup..."
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp -r /home/pluribus/plures/vaultbot /home/pluribus/plures/vaultbot.backup.$TIMESTAMP
            
            echo "ðŸ“¥ Fetching latest changes..."
            git fetch origin
            
            # Get current commit for rollback
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "ðŸ“Œ Current commit: $CURRENT_COMMIT"
            
            echo "ðŸ”„ Pulling latest main branch..."
            if ! git merge origin/main --ff-only; then
              echo "âŒ Merge failed! You may have local changes."
              echo "Current git status:"
              git status
              exit 1
            fi
            
            echo "ðŸ“¦ Updating dependencies..."
            /home/pluribus/plures/vaultbot/venv/bin/pip install -r requirements.txt
            
            echo "ðŸŽ­ Updating Playwright..."
            /home/pluribus/plures/vaultbot/venv/bin/playwright install chromium
        PLURIBUS_EOF
          
          echo "â–¶ï¸  Starting bot..."
          sudo systemctl start vaultbot.service
          
          echo "â³ Waiting for bot to start..."
          sleep 5
          
          # Health check
          if sudo systemctl is-active --quiet vaultbot.service; then
            echo "âœ… VaultBot is running!"
            sudo journalctl -u vaultbot.service -n 20 --no-pager
            
            # Clean up backup
            echo "ðŸ§¹ Cleaning up backup..."
            sudo su - pluribus << 'PLURIBUS_EOF'
              cd /home/pluribus/plures
              TIMESTAMP=$(ls -t | grep "vaultbot.backup" | head -1 | sed 's/vaultbot.backup.//')
              if [ -n "$TIMESTAMP" ]; then
                rm -rf vaultbot.backup.$TIMESTAMP
              fi
        PLURIBUS_EOF
            
            echo "ðŸŽ‰ Deployment complete!"
          else
            echo "âŒ Bot failed to start! Rolling back..."
            sudo systemctl stop vaultbot.service
            
            # Rollback
            sudo su - pluribus << 'PLURIBUS_EOF'
              cd /home/pluribus/plures
              
              # Find the backup we just made
              BACKUP=$(ls -t | grep "vaultbot.backup" | head -1)
              
              if [ -n "$BACKUP" ]; then
                echo "Restoring from $BACKUP..."
                rm -rf vaultbot
                mv $BACKUP vaultbot
              fi
        PLURIBUS_EOF
            
            sudo systemctl start vaultbot.service
            
            echo "ðŸ“‹ Recent logs:"
            sudo journalctl -u vaultbot.service -n 50 --no-pager
            
            exit 1
          fi
        ENDSSH
    
    - name: Notify Discord - Deployment Success
      if: success()
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_DEPLOY_WEBHOOK }}
      run: |
        COMMIT_MSG=$(cat << 'EOF'
        ${{ github.event.head_commit.message }}
        EOF
        )
        
        COMMIT_JSON=$(echo "$COMMIT_MSG" | jq -Rs .)
        
        cat > /tmp/webhook.json <<WEBHOOK_EOF
        {
          "embeds": [{
            "title": "ðŸš€ VaultBot Deployed",
            "description": "Successfully deployed to PiLab",
            "color": 5763719,
            "fields": [
              {
                "name": "Commit",
                "value": ${COMMIT_JSON},
                "inline": false
              },
              {
                "name": "Branch",
                "value": "${{ github.ref_name }}",
                "inline": true
              },
              {
                "name": "Author",
                "value": "${{ github.actor }}",
                "inline": true
              }
            ]
          }]
        }
        WEBHOOK_EOF
        
        curl -H "Content-Type: application/json" \
             -X POST \
             -d @/tmp/webhook.json \
             "$DISCORD_WEBHOOK"
    
    - name: Notify Discord - Deployment Failure
      if: failure()
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_DEPLOY_WEBHOOK }}
      run: |
        COMMIT_MSG=$(cat << 'EOF'
        ${{ github.event.head_commit.message }}
        EOF
        )
        
        COMMIT_JSON=$(echo "$COMMIT_MSG" | jq -Rs .)
        
        cat > /tmp/webhook.json <<WEBHOOK_EOF
        {
          "embeds": [{
            "title": "âŒ VaultBot Deployment Failed",
            "description": "Deployment to PiLab failed and was rolled back",
            "color": 15158332,
            "fields": [
              {
                "name": "Commit",
                "value": ${COMMIT_JSON},
                "inline": false
              },
              {
                "name": "Branch",
                "value": "${{ github.ref_name }}",
                "inline": true
              },
              {
                "name": "Check logs",
                "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "inline": false
              }
            ]
          }]
        }
        WEBHOOK_EOF
        
        curl -H "Content-Type: application/json" \
             -X POST \
             -d @/tmp/webhook.json \
             "$DISCORD_WEBHOOK"