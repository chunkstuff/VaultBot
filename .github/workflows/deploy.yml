name: Deploy VaultBot to PiLab

on:
  push:
    branches: 
      - main
      - dev
      - 'feat/**'
  workflow_dispatch:

jobs:
  # Notification job - runs for ALL branches
  notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Notify Discord
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_DEPLOY_WEBHOOK }}
      run: |
        COMMIT_MSG=$(cat << 'EOF'
        ${{ github.event.head_commit.message }}
        EOF
        )
        
        COMMIT_JSON=$(echo "$COMMIT_MSG" | jq -Rs .)
        
        if [ "${{ github.ref_name }}" = "main" ]; then
          TITLE="ðŸš€ VaultBot Deployed"
          DESC="Successfully deployed to PiLab"
          COLOR=5763719
        elif [ "${{ github.ref_name }}" = "dev" ]; then
          TITLE="âœ… Build Successful"
          DESC="Build passed for dev branch"
          COLOR=3447003
        else
          TITLE="âœ… Build Successful"
          DESC="Build passed for branch ${{ github.ref_name }}"
          COLOR=10181046
        fi
        
        cat > /tmp/webhook.json <<WEBHOOK_EOF
        {
          "embeds": [{
            "title": "${TITLE}",
            "description": "${DESC}",
            "color": ${COLOR},
            "fields": [
              {
                "name": "Commit",
                "value": ${COMMIT_JSON},
                "inline": false
              },
              {
                "name": "Branch",
                "value": "${{ github.ref_name }}",
                "inline": true
              },
              {
                "name": "Author",
                "value": "${{ github.actor }}",
                "inline": true
              }
            ]
          }]
        }
        WEBHOOK_EOF
        
        curl -H "Content-Type: application/json" \
             -X POST \
             -d @/tmp/webhook.json \
             "$DISCORD_WEBHOOK"

  # Deployment job - only runs for main branch
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
    
    - name: Setup SSH config for Cloudflare Tunnel
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/pi_key
        chmod 600 ~/.ssh/pi_key
        cat >> ~/.ssh/config << EOF
        Host pilab
          HostName ${{ secrets.PI_HOST }}
          User ${{ secrets.PI_USERNAME }}
          IdentityFile ~/.ssh/pi_key
          ProxyCommand cloudflared access ssh --hostname %h
        EOF
    
    - name: Deploy to Pi
      run: |
        ssh -o StrictHostKeyChecking=no pilab << 'ENDSSH'
          set -e  # Exit on any error
          
          echo "ðŸš€ Starting deployment of VaultBot..."
          
          # Navigate to existing installation
          cd /home/pluribus/plures/vaultbot
          
          # Verify we're in a git repo
          if [ ! -d ".git" ]; then
            echo "âŒ Not a git repository! Aborting."
            exit 1
          fi
          
          echo "ðŸ›‘ Stopping bot..."
          sudo systemctl stop vaultbot.service
          
          echo "ðŸ’¾ Creating safety backup..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          sudo cp -r /home/pluribus/plures/vaultbot /home/pluribus/plures/vaultbot.backup.$TIMESTAMP
          
          echo "ðŸ“¥ Fetching latest changes..."
          sudo -u pluribus git fetch origin
          
          # Get current commit for rollback
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "ðŸ“Œ Current commit: $CURRENT_COMMIT"
          
          echo "ðŸ”„ Pulling latest main branch..."
          # Use merge instead of reset --hard (safer!)
          if ! sudo -u pluribus git merge origin/main --ff-only; then
            echo "âŒ Merge failed! You may have local changes."
            echo "Current git status:"
            git status
            sudo systemctl start vaultbot.service
            exit 1
          fi
          
          echo "ðŸ“¦ Updating dependencies..."
          sudo -u pluribus /home/pluribus/plures/vaultbot/venv/bin/pip install -r requirements.txt
          
          echo "ðŸŽ­ Updating Playwright..."
          sudo -u pluribus /home/pluribus/plures/vaultbot/venv/bin/playwright install chromium
          
          echo "â–¶ï¸  Starting bot..."
          sudo systemctl start vaultbot.service
          
          echo "â³ Waiting for bot to start..."
          sleep 5
          
          # Health check - verify bot is actually running
          if sudo systemctl is-active --quiet vaultbot.service; then
            echo "âœ… VaultBot is running!"
            sudo journalctl -u vaultbot.service -n 20 --no-pager
            
            # Clean up old backup after successful deploy
            echo "ðŸ§¹ Cleaning up backup..."
            sudo rm -rf /home/pluribus/plures/vaultbot.backup.$TIMESTAMP
            
            echo "ðŸŽ‰ Deployment complete!"
          else
            echo "âŒ Bot failed to start! Rolling back..."
            sudo systemctl stop vaultbot.service
            
            # Rollback to previous commit
            sudo -u pluribus git reset --hard $CURRENT_COMMIT
            
            # Restore from backup if git rollback isn't enough
            if [ -d "/home/pluribus/plures/vaultbot.backup.$TIMESTAMP" ]; then
              sudo rm -rf /home/pluribus/plures/vaultbot
              sudo mv /home/pluribus/plures/vaultbot.backup.$TIMESTAMP /home/pluribus/plures/vaultbot
            fi
            
            sudo systemctl start vaultbot.service
            
            echo "ðŸ“‹ Recent logs:"
            sudo journalctl -u vaultbot.service -n 50 --no-pager
            
            exit 1
          fi
        ENDSSH
    
    - name: Notify Discord on Deployment Failure
      if: failure()
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_DEPLOY_WEBHOOK }}
      run: |
        COMMIT_MSG=$(cat << 'EOF'
        ${{ github.event.head_commit.message }}
        EOF
        )
        
        COMMIT_JSON=$(echo "$COMMIT_MSG" | jq -Rs .)
        
        cat > /tmp/webhook.json <<WEBHOOK_EOF
        {
          "embeds": [{
            "title": "âŒ VaultBot Deployment Failed",
            "description": "Deployment to PiLab failed and was rolled back",
            "color": 15158332,
            "fields": [
              {
                "name": "Commit",
                "value": ${COMMIT_JSON},
                "inline": false
              },
              {
                "name": "Branch",
                "value": "${{ github.ref_name }}",
                "inline": true
              },
              {
                "name": "Check logs",
                "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "inline": false
              }
            ]
          }]
        }
        WEBHOOK_EOF
        
        curl -H "Content-Type: application/json" \
             -X POST \
             -d @/tmp/webhook.json \
             "$DISCORD_WEBHOOK"